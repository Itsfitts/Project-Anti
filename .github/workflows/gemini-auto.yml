name: Gemini Auto - AI Code Fixer

# This workflow automatically fixes code issues using Google's Gemini AI
# and commits the fixes directly to pull requests
on:
  pull_request:
    types: [opened, synchronize, labeled]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  pre_check:
    name: Pre-check for Issues
    runs-on: ubuntu-latest
    outputs:
      has_issues: ${{ steps.check.outputs.has_issues }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Check for issues requiring fixes
        id: check
        run: |
          # Run quick pre-check to see if there are issues to fix
          if GEMINI_TEST_MODE=true node ./scripts/gemini-auto.js | grep -q "Issues detected"; then
            echo "has_issues=true" >> $GITHUB_OUTPUT
            echo "âœ… Issues detected - Gemini Auto will run"
          else
            echo "has_issues=false" >> $GITHUB_OUTPUT  
            echo "â„¹ï¸ No issues detected - Gemini Auto will be skipped"
          fi

  gemini_auto_fix:
    name: Gemini Auto Fix
    needs: pre_check
    # Only run if there are actual issues to fix AND conditions are met
    if: |
      needs.pre_check.outputs.has_issues == 'true' && (
        github.event.action == 'opened' ||
        github.event.action == 'synchronize' ||
        (github.event.action == 'labeled' && github.event.label.name == 'gemini-auto') ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Make Gradle wrapper executable
        run: chmod +x ./gradlew

      - name: Run Gemini Auto Analysis and Fix
        id: gemini_auto
        run: |
          # Security check: Verify API key is configured
          if [ -z "${{ secrets.GEMINI_API_KEY }}" ]; then
            echo "âš ï¸ GEMINI_API_KEY secret is not configured"
            echo "status=missing_key" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Run the Gemini Auto script with enhanced security
          if timeout 10m node ./scripts/gemini-auto.js; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "changes_made=true" >> $GITHUB_OUTPUT
          else
            echo "status=error" >> $GITHUB_OUTPUT
            exit 1
          fi
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}

      - name: Commit and push fixes
        if: steps.gemini_auto.outputs.changes_made == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "Gemini Auto"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "ğŸ¤– Gemini Auto: Apply AI-suggested fixes

            Auto-generated fixes by Gemini AI to improve code quality,
            performance, and adherence to best practices.
            
            - Fix linting issues
            - Optimize performance
            - Apply security improvements  
            - Standardize code formatting"
            git push
            echo "âœ… Gemini Auto fixes committed and pushed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi

      - name: Post status comment
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.gemini_auto.outputs.status }}';
            const changesMade = '${{ steps.gemini_auto.outputs.changes_made }}';
            
            let body = "## ğŸ¤– Gemini Auto\n\n";
            
            if (status === 'missing_key') {
              body += "ğŸ”§ **Setup Required**: Configure your Gemini API key for auto-fixes.\n\n";
              body += "### Quick Setup:\n";
              body += "1. Get a free API key at [Google AI Studio](https://makersuite.google.com/app/apikey)\n";
              body += "2. Add it as `GEMINI_API_KEY` in **Settings > Secrets and variables > Actions**\n";
              body += "3. Add label `gemini-auto` to this PR or push new commits to trigger fixes\n\n";
              body += "ğŸš€ **What Gemini Auto does**:\n";
              body += "- **Automatically fixes** linting issues\n";
              body += "- **Optimizes performance** bottlenecks\n";
              body += "- **Applies security** improvements\n";
              body += "- **Standardizes formatting** and style\n";
              body += "- **Commits fixes** directly to your PR\n";
            } else if (status === 'success' && changesMade === 'true') {
              body += "âœ… **Auto-fixes applied successfully!**\n\n";
              body += "ğŸ”§ **Changes made**:\n";
              body += "- Linting issues resolved\n";
              body += "- Performance optimizations applied\n";
              body += "- Code formatting standardized\n";
              body += "- Security improvements implemented\n\n";
              body += "ğŸ“ **Review the commit** above to see all changes made by Gemini Auto.";
            } else if (status === 'success') {
              body += "âœ… **Analysis complete - No fixes needed!**\n\n";
              body += "ğŸ‰ Your code is already following best practices.";
            } else {
              body += "âŒ **Error during auto-fix process**\n\n";
              body += "Please check the workflow logs for details.";
            }
            
            body += "\n\n---\n*Gemini Auto - Enhanced with Security & Efficiency*";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  no_issues_comment:
    name: No Issues Comment
    needs: pre_check
    # Run this job when there are no issues to fix
    if: |
      needs.pre_check.outputs.has_issues == 'false' && (
        github.event.action == 'opened' ||
        github.event.action == 'synchronize' ||
        (github.event.action == 'labeled' && github.event.label.name == 'gemini-auto') ||
        github.event_name == 'workflow_dispatch'
      )
    runs-on: ubuntu-latest
    
    steps:
      - name: Post no issues comment
        uses: actions/github-script@v7
        with:
          script: |
            const body = "## ğŸ¤– Gemini Auto\n\n" +
              "âœ… **No issues detected!**\n\n" +
              "ğŸ‰ Your code already follows best practices. No fixes needed.\n\n" +
              "---\n*Gemini Auto - Enhanced with Security & Efficiency*";
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });